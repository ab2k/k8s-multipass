bootcmd:
- curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
- echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
growpart:
  mode: auto
  devices: ["/"]
fqdn: k8s-control
preserve_hostname: true
prefer_fqdn_over_hostname: true
timezone: Europe/Moscow
locale: "en_US.UTF-8"
package_update: true
package_upgrade: true
preserve_sources_list: true
package_reboot_if_required: false
manage_resolv_conf: true
resolv_conf:
  nameservers: ['8.8.4.4', '8.8.8.8']
packages:
  - containerd
  - kubeadm=1.21.0-00
  - kubelet=1.21.0-00
  - kubectl=1.21.0-00
  - apt-transport-https
  - ca-certificates
  - curl
  - jq
write_files:
  - path: /etc/modules-load.d/containerd.conf
    content: |
      overlay
      br_netfilter
  - path: /etc/sysctl.d/99-kubernetes-cri.conf
    content: |
      net.ipv4.ip_forward=1
      net.bridge.bridge-nf-call-iptables=1
      net.bridge.bridge-nf-call-ip6tables=1
runcmd:
- mkdir /etc/containerd
- containerd config default > /etc/containerd/config.toml
- systemctl enable containerd.service
- apt-mark hold kubelet kubeadm kubectl
power_state:
  delay: now
  mode: reboot
